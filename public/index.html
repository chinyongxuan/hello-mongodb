<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyTaxi 2026</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* --- 1. VARIABLES & RESET --- */
        :root {
            --primary-color: #007bff;       
            --primary-hover: #0056b3;
            --danger-color: #dc3545;        
            --success-color: #28a745;       
            --bg-color: #f4f7f6;            
            --card-color: #ffffff;          
            --text-main: #2c3e50;           
            --text-light: #6c757d;          
            --border-radius: 8px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; padding: 0; line-height: 1.6; }
        .container { max-width: 900px; margin: 40px auto; padding: 0 20px; }
        .header-title { text-align: center; color: var(--text-main); font-weight: 700; margin-bottom: 10px; font-size: 2.5rem; letter-spacing: -1px; }

        /* --- NAVIGATION --- */
        nav { background: var(--card-color); padding: 15px 30px; box-shadow: var(--shadow); display: flex; justify-content: space-between; align-items: center; border-radius: var(--border-radius); margin-bottom: 30px; }
        #userWelcome { font-weight: 600; color: var(--text-main); }

        /* --- SECTIONS --- */
        .section { display: none; background: var(--card-color); padding: 40px; border-radius: var(--border-radius); box-shadow: var(--shadow); border: 1px solid #eaeaea; animation: fadeIn 0.4s ease-in-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 { margin-top: 0; color: var(--text-main); font-size: 1.8rem; }
        h3 { color: var(--text-light); font-size: 1.2rem; margin-top: 30px; margin-bottom: 15px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }

        /* --- PROFILE CARD --- */
        .profile-card { background: #f8f9fa; padding: 20px; border-radius: var(--border-radius); border-left: 5px solid var(--primary-color); margin-bottom: 30px; position: relative; }
        .profile-row { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .profile-label { font-weight: 600; color: var(--text-light); }
        .profile-value { font-weight: 500; color: var(--text-main); }
        .edit-btn { position: absolute; top: 20px; right: 20px; width: auto; font-size: 0.8rem; padding: 5px 10px; background: var(--text-light); }

        /* --- FORMS & INPUTS --- */
        input, select { width: 100%; padding: 12px; margin: 8px 0 20px 0; border: 1px solid #ced4da; border-radius: var(--border-radius); font-size: 1rem; box-sizing: border-box; transition: border-color 0.3s, box-shadow 0.3s; }
        input:focus, select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15); }

        /* --- BUTTONS --- */
        button { cursor: pointer; padding: 12px 24px; border: none; border-radius: var(--border-radius); font-size: 1rem; font-weight: 500; transition: all 0.2s ease; width: 100%; margin-bottom: 10px; background-color: var(--primary-color); color: white; }
        button:hover { background-color: var(--primary-hover); transform: translateY(-1px); }
        button.btn-danger { background-color: var(--danger-color); }
        button.btn-danger:hover { background-color: #c82333; }
        button.btn-secondary { background-color: #6c757d; }
        button.btn-secondary:hover { background-color: #5a6268; }
        td button { width: auto; padding: 6px 12px; font-size: 0.9rem; margin: 0 2px; }

        /* --- TABLES --- */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; border-radius: var(--border-radius); overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; font-weight: 600; color: var(--text-light); text-transform: uppercase; font-size: 0.85rem; letter-spacing: 0.5px; }
        tr:hover { background-color: #fcfcfc; }

        /* --- FEEDBACK & UTILS --- */
        #messageBox { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 15px 25px; border-radius: 50px; color: white; font-weight: 600; z-index: 2000; opacity: 0; transition: opacity 0.5s; box-shadow: 0 4px 12px rgba(0,0,0,0.15); pointer-events: none; }
        .error { background-color: var(--danger-color); opacity: 1 !important; }
        .success { background-color: var(--success-color); opacity: 1 !important; }

        .divider { border: 0; border-top: 1px solid #eee; margin: 30px 0; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        /* --- MODALS --- */
        .modal { display:none; position:fixed; top:50%; left:50%; transform: translate(-50%, -50%); background:white; padding:30px; width: 90%; max-width: 400px; z-index:1000; box-shadow: 0 20px 50px rgba(0,0,0,0.3); border-radius: 12px; }
        .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999; }

        @media (max-width: 600px) { .container { margin: 10px auto; } .section { padding: 20px; } }
    </style>
</head>
<body>

    <div class="container">
        <h1 class="header-title">MyTaxi 2026</h1>

        <nav id="navBar" style="display:none;">
            <span id="userWelcome">Welcome</span>
            <button onclick="logout()" class="btn-danger" style="width: auto; margin:0;">Logout</button>
        </nav>

        <div id="messageBox"></div>

        <div id="authSection" class="section active">
            <h2>Welcome Back</h2>
            <p style="color:var(--text-light); margin-bottom: 20px;">Please login to your account.</p>
            <input type="email" id="loginEmail" placeholder="Email Address">
            <input type="password" id="loginBx" placeholder="Password">
            <button onclick="login()">Log In</button>
            <hr class="divider">
            <h3>Create an Account</h3>
            <select id="regRole">
                <option value="customer">I am a Customer</option>
                <option value="driver">I am a Driver</option>
            </select>
            <input type="text" id="regName" placeholder="Full Name">
            <input type="email" id="regEmail" placeholder="Email Address">
            <input type="password" id="regPass" placeholder="Password">
            <input type="text" id="regPhone" placeholder="Phone Number">
            <div id="driverFields" style="display:none; background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="margin-top:0;">Vehicle Details</h4>
                <input type="text" id="regPlate" placeholder="Car Plate Number">
                <input type="text" id="regModel" placeholder="Car Model (e.g. Toyota Camry)">
                <input type="text" id="regColor" placeholder="Car Color">
            </div>
            <button onclick="register()" class="btn-secondary">Register Now</button>
        </div>

        <div id="customerDashboard" class="section">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>Customer Dashboard</h2>
            </div>

            <div class="profile-card">
                <button class="edit-btn" onclick="openEditProfileModal()">Edit Profile</button>
                <h3 style="margin-top:0; border:none; color:var(--primary-color);">My Profile</h3>
                <div id="customerProfileDetails">Loading...</div>
            </div>
            
            <div style="background: #eef2f7; padding: 20px; border-radius: 10px; margin-top: 20px;">
                <h3 style="margin-top:0; border:none;">Request a Ride</h3>
                <div class="grid-2">
                    <input type="text" id="pickup" placeholder="From: Pickup Location" style="margin-bottom:0;">
                    <input type="text" id="destination" placeholder="To: Destination" style="margin-bottom:0;">
                </div>
                <button onclick="requestRide()" style="margin-top:15px;">Book Ride Now</button>
            </div>

            <h3>Payment Wallet</h3>
            <div style="background: #fff; border: 1px solid #eee; padding: 15px; border-radius: 8px;">
                <div id="paymentList">Loading cards...</div>
                <hr style="margin: 15px 0; border:0; border-top:1px solid #eee;">
                
                <div class="grid-2">
                    <input type="text" id="cardNum" placeholder="Card Number">
                    
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="cardExp" placeholder="MM/YY" style="flex: 2;">
                        <input type="text" id="cardCvv" placeholder="CVV" style="flex: 1;"> 
                    </div>
                </div>
                
                <button onclick="addPayment()" class="btn-secondary" style="width: auto;">+ Add Card</button>
            </div>
                

            <h3>My Ride History</h3>
            <button onclick="loadCustomerRides()" class="btn-secondary" style="width:auto;">Refresh History</button>
            <div id="customerRideList"></div>
            
            <h3>My Reviews</h3>
            <button onclick="loadPersonalRatings('customerRatingList')" class="btn-secondary" style="width:auto;">View My Ratings</button>
            <div id="customerRatingList"></div>
        </div>

        <div id="driverDashboard" class="section">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>Driver Dashboard</h2>
                <div id="driverStatusDisplay" style="font-weight:bold; color:var(--text-light);">Status: Checking...</div>
            </div>

            <div class="profile-card">
                <button class="edit-btn" onclick="openEditProfileModal()">Edit Profile</button>
                <h3 style="margin-top:0; border:none; color:var(--primary-color);">My Profile</h3>
                <div id="driverProfileDetails">Loading...</div>
            </div>
            
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button onclick="updateDriverStatus(true)" style="background-color: var(--success-color);">Go Online</button>
                <button onclick="updateDriverStatus(false)" class="btn-secondary">Go Offline</button>
            </div>

            <h3>Available Requests</h3>
            <button onclick="loadAvailableRides()" style="width:auto;">Refresh Requests</button>
            <div id="availableRideList"></div>

            <h3>My Jobs</h3>
            <button onclick="loadDriverRides()" class="btn-secondary" style="width:auto;">Refresh Jobs</button>
            <div id="driverRideList"></div>

            <h3>Reviews from Customers</h3>
            <button onclick="loadPersonalRatings('driverRatingList')" class="btn-secondary" style="width:auto;">View Reviews</button>
            <div id="driverRatingList"></div>
        </div>

        <div id="adminDashboard" class="section">
            <h2>Admin Panel</h2>
            <h3>Pending Driver Approvals</h3>
            <button onclick="loadAdminDrivers()" style="width:auto;">Refresh Drivers</button>
            <div id="adminDriverList"></div>
            <h3>User Management</h3>
            <button onclick="loadAdminCustomers()" style="width:auto;">Refresh Customers</button>
            <div id="adminCustomerList"></div>
            <h3>System Rides</h3>
            <button onclick="loadAdminRides()" style="width:auto;">Refresh Rides</button>
            <div id="adminRideList"></div>
            <h3>System Ratings</h3>
            <button onclick="loadAdminRatings()" style="width:auto;">Refresh Ratings</button>
            <div id="adminRatingList"></div>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay"></div>

    <div id="ratingModal" class="modal">
        <h3 style="margin-top:0; text-align:center;">Rate Your Driver</h3>
        <input type="hidden" id="rateRideId">
        <input type="hidden" id="rateDriverId">
        <input type="number" id="ratingValue" min="1" max="5" placeholder="Stars (1-5)">
        <input type="text" id="ratingComment" placeholder="Write a comment...">
        <button onclick="submitRating()">Submit Rating</button>
        <button onclick="closeModals()" class="btn-secondary">Cancel</button>
    </div>

    <div id="editProfileModal" class="modal">
        <h3 style="margin-top:0; text-align:center;">Edit Profile</h3>
        <input type="text" id="editName" placeholder="Full Name">
        <input type="text" id="editEmail" placeholder="Email">
        <input type="text" id="editPhone" placeholder="Phone">
        
        <div id="editDriverFields" style="display:none;">
            <input type="text" id="editPlate" placeholder="Car Plate">
            <input type="text" id="editModel" placeholder="Car Model">
            <input type="text" id="editColor" placeholder="Color">
        </div>
        
        <button onclick="updateProfile()">Save Changes</button>
        <button onclick="closeModals()" class="btn-secondary">Cancel</button>
    </div>

    <script>
        const API_URL = ''; // Auto-detects Azure URL
        let currentUser = null;
        let token = localStorage.getItem('token');
        let currentProfileData = {}; // Store raw profile data for editing

        document.getElementById('regRole').addEventListener('change', (e) => {
            document.getElementById('driverFields').style.display = e.target.value === 'driver' ? 'block' : 'none';
        });

        // --- AUTH ---
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginBx').value;
            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if (res.ok) {
                    token = data.token;
                    localStorage.setItem('token', token);
                    parseTokenAndRedirect(token);
                } else { showMessage(data.error || 'Login failed', true); }
            } catch (err) { showMessage('Server error', true); }
        }

        async function register() {
            const role = document.getElementById('regRole').value;
            const endpoint = role === 'customer' ? '/customers' : '/drivers';
            const body = {
                name: document.getElementById('regName').value,
                email: document.getElementById('regEmail').value,
                password: document.getElementById('regPass').value,
                phone: document.getElementById('regPhone').value
            };
            if (role === 'driver') {
                body.plateNumber = document.getElementById('regPlate').value;
                body.model = document.getElementById('regModel').value;
                body.color = document.getElementById('regColor').value;
            }
            try {
                const res = await fetch(`${API_URL}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (res.ok) {
                    showMessage('Registration successful! Please login.');
                    document.getElementById('regEmail').value = '';
                    document.getElementById('regPass').value = '';
                } else {
                    const d = await res.json();
                    showMessage(d.error || 'Registration failed', true);
                }
            } catch (err) { showMessage('Error connecting to server', true); }
        }

        async function logout() {
            if (currentUser && currentUser.role === 'driver') {
                try {
                    await fetch(`${API_URL}/drivers/${currentUser.userId}/status`, {
                        method: 'PATCH',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ available: false })
                    });
                } catch (err) { console.log("Error setting offline status:", err); }
            }
            token = null;
            currentUser = null;
            localStorage.removeItem('token');
            showSection('authSection');
            document.getElementById('navBar').style.display = 'none';
            document.getElementById('driverStatusDisplay').innerText = "Status: Checking...";
        }

        function parseTokenAndRedirect(jwtToken) {
            if (!jwtToken) return;
            const payload = JSON.parse(atob(jwtToken.split('.')[1]));
            currentUser = payload;
            
            document.getElementById('userWelcome').innerText = `Hello, ${payload.role.charAt(0).toUpperCase() + payload.role.slice(1)}`;
            document.getElementById('navBar').style.display = 'flex';

            loadUserProfile();

            if (payload.role === 'customer') {
                showSection('customerDashboard');
                loadCustomerRides();
                loadPayments(); // NEW: Load payments
            } else if (payload.role === 'driver') {
                showSection('driverDashboard');
                loadDriverRides(); 
                loadAvailableRides();
                checkDriverStatus(); 
            } else if (payload.role === 'admin') {
                showSection('adminDashboard');
            }
        }

        // --- PROFILE & EDITING ---
        async function loadUserProfile() {
            if (!currentUser || currentUser.role === 'admin') return;

            const endpoint = currentUser.role === 'customer' ? `/customers/${currentUser.userId}` : `/drivers/${currentUser.userId}`;
            const targetDiv = currentUser.role === 'customer' ? 'customerProfileDetails' : 'driverProfileDetails';

            try {
                const res = await fetch(`${API_URL}${endpoint}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const user = await res.json();
                currentProfileData = user; // Store for editing
                
                let html = `
                    <div class="profile-row"><span class="profile-label">Name:</span> <span class="profile-value">${user.name}</span></div>
                    <div class="profile-row"><span class="profile-label">Email:</span> <span class="profile-value">${user.email}</span></div>
                    <div class="profile-row"><span class="profile-label">Phone:</span> <span class="profile-value">${user.phone}</span></div>
                `;

                if (currentUser.role === 'driver') {
                    html += `
                    <div class="profile-row"><span class="profile-label">Car Plate:</span> <span class="profile-value">${user.plateNumber || '-'}</span></div>
                    <div class="profile-row"><span class="profile-label">Car Model:</span> <span class="profile-value">${user.model || '-'}</span></div>
                    <div class="profile-row"><span class="profile-label">Color:</span> <span class="profile-value">${user.color || '-'}</span></div>
                    `;
                }

                document.getElementById(targetDiv).innerHTML = html;
            } catch (err) {
                console.error("Profile load error", err);
                document.getElementById(targetDiv).innerHTML = "Failed to load profile.";
            }
        }

        function openEditProfileModal() {
            // Pre-fill data
            document.getElementById('editName').value = currentProfileData.name || '';
            document.getElementById('editEmail').value = currentProfileData.email || '';
            document.getElementById('editPhone').value = currentProfileData.phone || '';

            const driverDiv = document.getElementById('editDriverFields');
            if (currentUser.role === 'driver') {
                driverDiv.style.display = 'block';
                document.getElementById('editPlate').value = currentProfileData.plateNumber || '';
                document.getElementById('editModel').value = currentProfileData.model || '';
                document.getElementById('editColor').value = currentProfileData.color || '';
            } else {
                driverDiv.style.display = 'none';
            }

            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById('editProfileModal').style.display = 'block';
        }

        async function updateProfile() {
            const endpoint = currentUser.role === 'customer' ? `/customers/${currentUser.userId}` : `/drivers/${currentUser.userId}`;
            
            const body = {
                name: document.getElementById('editName').value,
                email: document.getElementById('editEmail').value,
                phone: document.getElementById('editPhone').value
            };

            if (currentUser.role === 'driver') {
                body.plateNumber = document.getElementById('editPlate').value;
                body.model = document.getElementById('editModel').value;
                body.color = document.getElementById('editColor').value;
            }

            const res = await fetch(`${API_URL}${endpoint}`, {
                method: 'PATCH',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (res.ok) {
                showMessage('Profile updated!');
                closeModals();
                loadUserProfile(); // Refresh display
            } else {
                showMessage('Update failed', true);
            }
        }

        // --- PAYMENT METHODS ---
        async function loadPayments() {
            if(!currentUser || currentUser.role !== 'customer') return;

            // This GET endpoint needs to be added to backend
            const res = await fetch(`${API_URL}/customers/${currentUser.userId}/payments`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if(!res.ok) {
                document.getElementById('paymentList').innerHTML = "No cards found.";
                return;
            }

            const cards = await res.json();
            if (cards.length === 0) {
                document.getElementById('paymentList').innerHTML = "<i>No cards linked.</i>";
                return;
            }

            let html = `<ul style="list-style:none; padding:0;">`;
            cards.forEach(c => {
                html += `<li style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding:5px 0;">
                    <span>üí≥ **** ${c.last4} (Exp: ${c.expiry})</span>
                    <button class="btn-danger" style="width:auto; font-size:0.8rem; padding:4px 8px;" onclick="deletePayment('${c._id}')">Remove</button>
                </li>`;
            });
            html += `</ul>`;
            document.getElementById('paymentList').innerHTML = html;
        }

        async function addPayment() {
            // 1. Get values from the HTML inputs
            const num = document.getElementById('cardNum').value;
            const exp = document.getElementById('cardExp').value;
                
            const cvvInput = document.getElementById('cardCvv'); 
            const cvv = cvvInput ? cvvInput.value : ''; 
                
            // 2. Validate
            if (!num || !exp || !cvv) return showMessage('Enter all card details (Num, Exp, CVV)', true);
                
            // 3. Send to backend
            const res = await fetch(`${API_URL}/payments`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ cardNumber: num, expiry: exp, cvv: cvv }) 
            });
        
            if (res.ok) {
                showMessage('Card added!');
                // Clear inputs
                document.getElementById('cardNum').value = '';
                document.getElementById('cardExp').value = '';
                if(cvvInput) cvvInput.value = '';
                loadPayments();
            } else {
                showMessage('Failed to add card', true);
            }
        }

        async function deletePayment(id) {
            if(!confirm("Remove this card?")) return;
            const res = await fetch(`${API_URL}/payments/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if(res.ok) {
                showMessage('Card removed');
                loadPayments();
            } else {
                showMessage('Failed to remove', true);
            }
        }


        // --- CUSTOMER RIDES ---
        async function requestRide() {
            const pickup = document.getElementById('pickup').value;
            const destination = document.getElementById('destination').value;
            const res = await fetch(`${API_URL}/rides`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ pickupLocation: pickup, destination: destination, fare: 20 })
            });
            if (res.ok) {
                showMessage('Ride requested successfully!');
                loadCustomerRides();
            }
        }
        
        async function loadCustomerRides() {
            if(!currentUser) return;
            const res = await fetch(`${API_URL}/customers/${currentUser.userId}/rides`, { headers: { 'Authorization': `Bearer ${token}` } });
            const rides = await res.json();
            document.getElementById('customerRideList').innerHTML = rides.length ? buildRideTable(rides, 'customer') : '<p style="text-align:center; color:#999;">No rides found.</p>';
        }

        async function cancelRide(rideId) {
            if(!confirm("Are you sure you want to cancel this ride request?")) return;
            
            const res = await fetch(`${API_URL}/rides/${rideId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (res.ok) {
                showMessage('Ride cancelled successfully');
                loadCustomerRides();
            } else {
                const data = await res.json();
                showMessage(data.error || 'Failed to cancel ride', true);
            }
        }

        // --- DRIVER ---
        async function loadAvailableRides() {
            const res = await fetch(`${API_URL}/rides/requested`, { 
                headers: { 'Authorization': `Bearer ${token}` } 
            });
            
            if (!res.ok) {
                const data = await res.json();
                document.getElementById('availableRideList').innerHTML = 
                    `<p style="text-align:center; color:var(--danger-color); font-weight:bold;">${data.error || 'Access Denied'}</p>`;
                return;
            }

            const rides = await res.json();
            document.getElementById('availableRideList').innerHTML = 
                rides.length ? buildRideTable(rides, 'driver-available') : '<p style="text-align:center; color:#999;">No new requests.</p>';
        }

        async function loadDriverRides() {
            if(!currentUser) return;
            const res = await fetch(`${API_URL}/drivers/${currentUser.userId}/rides`, { headers: { 'Authorization': `Bearer ${token}` } });
            const rides = await res.json();
            document.getElementById('driverRideList').innerHTML = rides.length ? buildRideTable(rides, 'driver-history') : '<p style="text-align:center; color:#999;">No jobs history.</p>';
        }
        async function checkDriverStatus() {
            if(!currentUser) return;
            try {
                const res = await fetch(`${API_URL}/drivers/${currentUser.userId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                const driver = await res.json();
                const isOnline = driver.available === true;
                const statusEl = document.getElementById('driverStatusDisplay');
                statusEl.innerText = isOnline ? 'Status: Online' : 'Status: Offline';
                statusEl.style.color = isOnline ? 'var(--success-color)' : 'var(--text-light)';
            } catch (err) { console.error("Failed to sync status"); }
        }
        async function updateDriverStatus(isAvailable) {
            if(!currentUser) return;
            const res = await fetch(`${API_URL}/drivers/${currentUser.userId}/status`, {
                method: 'PATCH',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ available: isAvailable })
            });

            if (!res.ok) {
                const data = await res.json();
                showMessage(data.error || 'Failed to update status', true);
                return; 
            }
            checkDriverStatus(); 
        }
        async function updateRideStatus(rideId, status) {
            let action = '';
            if (status === 'accepted') action = 'accept';
            if (status === 'rejected') action = 'reject';
            if (status === 'ongoing') action = 'start';
            if (status === 'completed') action = 'end';
            const res = await fetch(`${API_URL}/rides/${rideId}/${action}`, { method: 'PATCH', headers: { 'Authorization': `Bearer ${token}` } });
            if(res.ok) {
                showMessage(`Ride ${status}`);
                loadAvailableRides();
                loadDriverRides();
            } else {
                const d = await res.json();
                showMessage(d.error || 'Action failed', true);
            }
        }

        // --- RATINGS ---
        function openRatingModal(rideId, driverId) {
            document.getElementById('rateRideId').value = rideId;
            document.getElementById('rateDriverId').value = driverId;
            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById('ratingModal').style.display = 'block';
        }
        function closeModals() {
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('ratingModal').style.display = 'none';
            document.getElementById('editProfileModal').style.display = 'none';
        }

        async function submitRating() {
            const rideId = document.getElementById('rateRideId').value;
            const driverId = document.getElementById('rateDriverId').value;
            const rating = document.getElementById('ratingValue').value;
            const comment = document.getElementById('ratingComment').value;
            const res = await fetch(`${API_URL}/ratings`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ rideId, driverId, rating, comment })
            });
            if(res.ok) {
                showMessage('Rating submitted!');
                closeModals();
            } else { showMessage('Failed to submit rating', true); }
        }
        async function loadPersonalRatings(elementId) {
        const res = await fetch(`${API_URL}/ratings`, { headers: { 'Authorization': `Bearer ${token}` } });
        const ratings = await res.json();
        
        let nameHeader = currentUser.role === 'customer' ? '<th>Rated Driver</th>' : '<th>From Customer</th>';
        
        // Added "Ride" column
        let html = `<table><tr>${nameHeader}<th>Ride</th><th>Rating</th><th>Comment</th></tr>`;
        
        ratings.forEach(r => {
            let displayName = currentUser.role === 'customer' ? (r.driverName || 'Unknown') : (r.customerName || 'Unknown');
            let rideInfo = r.rideTo ? `${r.rideFrom} ‚ûù ${r.rideTo}` : '<i>Deleted Ride</i>';

            html += `<tr>
                <td>${displayName}</td>
                <td><small>${rideInfo}</small></td>
                <td><span style="color:#f1c40f;">‚òÖ</span> ${r.rating} / 5</td>
                <td>${r.comment || '-'}</td>
            </tr>`;
        });
        html += '</table>';
        document.getElementById(elementId).innerHTML = ratings.length ? html : '<p style="text-align:center; color:#999;">No ratings yet.</p>';
    }

        // --- ADMIN ---
        async function loadAdminDrivers() {
            const res = await fetch(`${API_URL}/admin/drivers`, { headers: { 'Authorization': `Bearer ${token}` } });
            const drivers = await res.json();
            let html = '<table><tr><th>Name</th><th>Email</th><th>Approved</th><th>Action</th></tr>';
            drivers.forEach(d => {
                html += `<tr><td>${d.name}</td><td>${d.email}</td>
                    <td>${d.approved ? '<span style="color:green">Yes</span>' : '<span style="color:red">No</span>'}</td>
                    <td>${!d.approved ? `<button class="btn-secondary" onclick="approveDriver('${d._id}')">Approve</button>` : ''} 
                    <button class="btn-danger" onclick="deleteUser('drivers', '${d._id}')">Delete</button></td></tr>`;
            });
            html += '</table>';
            document.getElementById('adminDriverList').innerHTML = html;
        }
        async function loadAdminCustomers() {
            const res = await fetch(`${API_URL}/admin/customers`, { headers: { 'Authorization': `Bearer ${token}` } });
            const customers = await res.json();
            let html = '<table><tr><th>Name</th><th>Email</th><th>Action</th></tr>';
            customers.forEach(c => {
                html += `<tr><td>${c.name}</td><td>${c.email}</td><td><button class="btn-danger" onclick="deleteUser('customers', '${c._id}')">Delete</button></td></tr>`;
            });
            html += '</table>';
            document.getElementById('adminCustomerList').innerHTML = html;
        }
        async function loadAdminRides() {
            const res = await fetch(`${API_URL}/admin/rides`, { headers: { 'Authorization': `Bearer ${token}` } });
            const rides = await res.json();
            document.getElementById('adminRideList').innerHTML = rides.length ? buildRideTable(rides, 'admin') : '<p>No rides found.</p>';
        }
        async function loadAdminRatings() {
            const res = await fetch(`${API_URL}/admin/ratings`, { headers: { 'Authorization': `Bearer ${token}` } });
            const ratings = await res.json();
            if (!ratings || ratings.length === 0) {
                document.getElementById('adminRatingList').innerHTML = '<p>No ratings found.</p>';
                return;
            }
            let html = '<table><tr><th>Customer</th><th>Driver</th><th>Rating</th><th>Comment</th></tr>';
            ratings.forEach(r => {
                html += `<tr><td>${r.customerName || 'Unknown'}</td><td>${r.driverName || 'Unknown'}</td><td>${r.rating} / 5</td><td>${r.comment || '-'}</td></tr>`;
            });
            html += '</table>';
            document.getElementById('adminRatingList').innerHTML = html;
        }
        async function approveDriver(id) {
            await fetch(`${API_URL}/admin/drivers/${id}/approve`, { method: 'PATCH', headers: { 'Authorization': `Bearer ${token}` } });
            loadAdminDrivers();
        }
        async function deleteUser(collection, id) {
            if(!confirm('Are you sure?')) return;
            await fetch(`${API_URL}/admin/${collection}/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
            if(collection === 'drivers') loadAdminDrivers();
            else loadAdminCustomers();
        }

        // --- UTILS ---
        function buildRideTable(rides, viewType) {
        // Dynamic Header
        let partnerHeader = viewType === 'customer' ? 'Driver' : 'Customer';
        if(viewType === 'admin') partnerHeader = 'Participants (Customer / Driver)'; // Update Header for Admin

        let html = `<table><tr><th>Route</th><th>${partnerHeader}</th><th>Status</th><th>Action</th></tr>`;
        
        rides.forEach(r => {
            let actionBtns = '';
            let partnerDisplay = '-';

            // 1. CUSTOMER VIEW: Show Driver Name
            if (viewType === 'customer') {
                partnerDisplay = r.driverName 
                    ? `<b>${r.driverName}</b><br><small>${r.carModel || ''}</small>` 
                    : '<i>Finding Driver...</i>';
            } 
            // 2. DRIVER VIEW: Show Customer Name (Now works because backend sends customerName)
            else if (viewType === 'driver-history' || viewType === 'driver-available') {
                partnerDisplay = r.customerName || '<i>Unknown</i>';
            }
            // 3. ADMIN VIEW: Show Both
            else if (viewType === 'admin') {
                const cust = r.customerName || 'Unknown';
                const driv = r.driverName || '<span style="color:#999; font-style:italic;">Pending</span>';
                partnerDisplay = `<b>C:</b> ${cust}<br><b>D:</b> ${driv}`;
            }

            // ... (Keep your existing button logic below exactly as it was) ...
            if(viewType === 'driver-available' && r.status === 'requested') actionBtns = `<button onclick="updateRideStatus('${r._id}', 'accepted')">Accept</button>`;
            if(viewType === 'driver-history') {
                if (r.status === 'accepted') actionBtns = `<button style="background:#f39c12" onclick="updateRideStatus('${r._id}', 'ongoing')">Start</button>`;
                else if (r.status === 'ongoing') actionBtns = `<button style="background:#2ecc71" onclick="updateRideStatus('${r._id}', 'completed')">Complete</button>`;
                else if (r.status === 'completed') actionBtns = `<span style="color:green">Done</span>`;
            }
            if(viewType === 'customer') {
                if(r.status === 'requested' || r.status === 'accepted') {
                    actionBtns = `<button class="btn-danger" onclick="cancelRide('${r._id}')">Cancel</button>`;
                }
                else if (r.status === 'completed' && r.driverId) {
                        actionBtns = `<button class="btn-secondary" onclick="openRatingModal('${r._id}', '${r.driverId}')">Rate</button>`;
                }
            }

            html += `<tr>
                <td><b>From:</b> ${r.pickupLocation || '?'}<br><b>To:</b> ${r.destination || '?'}</td>
                <td>${partnerDisplay}</td>
                <td><span style="padding:4px 8px; border-radius:4px; font-size:0.8em; background:${r.status==='completed'?'#d4edda':'#fff3cd'}">${r.status.toUpperCase()}</span></td>
                <td>${actionBtns}</td>
            </tr>`;
        });
        html += '</table>';
        return html;
    }

        function showSection(id) {
            document.querySelectorAll('.section').forEach(d => d.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
        function showMessage(msg, isError = false) {
            const el = document.getElementById('messageBox');
            el.innerText = msg;
            el.className = isError ? 'error' : 'success';
            setTimeout(() => el.className = '', 3000);
        }

        if (token) parseTokenAndRedirect(token);
    </script>
</body>
</html>